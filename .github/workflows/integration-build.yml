name: Integration Build

on:
  schedule:
    - cron: "0 2 * * *"     # Runs at 2:00 AM UTC daily
  workflow_dispatch:        # Allows manual trigger
    inputs:
      java_version:
        description: 'Java version to use'
        type: choice
        required: true
        default: '["17"]'
        options:
          - '["17"]'
          - '["21"]'
          - '["25"]'
          - '["17", "21"]'
          - '["17", "25"]'
          - '["21", "25"]'
          - '["17", "21", "25"]'
      skip_build:
        description: 'Build: By default skipped. Deactivate to perform the regular project build'
        type: boolean
        default: true
      skip_tests:
        description: 'Build: Skip test execution for faster build'
        type: boolean
        default: true
      integration_tests:
        description: 'Integration Tests: Enable/Disable'
        type: boolean
        default: true
      testsuite:
        description: 'Integration Tests: Test suite to run'
        type: choice
        required: true
        default: '["engine", "webapps"]'
        options:
          - '["engine"]'
          - '["webapps"]'
          - '["engine", "webapps"]'
      distro:
        description: 'Integration Tests: Distribution to use'
        type: choice
        required: true
        default: '["operaton", "tomcat", "wildfly"]'
        options:
          - '["operaton"]'
          - '["tomcat"]'
          - '["wildfly"]'
          - '["operaton", "tomcat", "wildfly"]'
      database:
        description: 'Integration Tests: Database to use'
        type: choice
        required: true
        default: '["h2"]'
        options:
          - '["h2"]'
          - '["postgresql"]'
          - '["postgresql-xa"]'
          - '["mariadb"]'
          - '["sqlserver"]'
          - '["mysql"]'
          - '["oracle"]'
          - '["db2"]'
          - '["h2", "postgresql"]'
          - '["h2", "postgresql", "mariadb", "mysql", "oracle", "db2"]'
      dry_run:
        description: 'Release: Skips remote operations when true'
        type: boolean
        required: true
        default: false
  pull_request:             # Runs on pull requests to main
    branches: ["main"]
  push:
    branches:
      # when developing the workflow itself, create this branch and push to it
      - ci-dev/integration-build

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  detect-recent-changes:
    name: Detect recent changes
    runs-on: ubuntu-latest
    outputs:
      recent_changes: ${{steps.check-commits.outputs.commits}}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Check for recent commits
        id: check-commits
        run: |
          COMMITS=$(git rev-list --since="24 hours ago" HEAD)
          if [ -z "$COMMITS" ]; then
            echo "🔎❌ No commits in the last 24 hours detected."
            echo "commits=false" >> $GITHUB_OUTPUT
          else
            echo "🔎✔️ Commits within the last 24 hours detected."
            echo "commits=true" >> $GITHUB_OUTPUT
          fi

  determine-pr-config:
    name: Determine PR Configuration
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    outputs:
      needs_integration_build: ${{ steps.check-pr.outputs.needs_build }}
      java_versions: ${{ steps.compute-matrix.outputs.java_versions }}
      distros: ${{ steps.compute-matrix.outputs.distros }}
      databases: ${{ steps.compute-matrix.outputs.databases }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Check PR conditions
        id: check-pr
        env:
          PR_LABELS: ${{ toJson(github.event.pull_request.labels.*.name) }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          echo "PR Labels: $PR_LABELS"
          echo "PR Author: $PR_AUTHOR"
          
          # Define whitelisted authors (core team members who don't need full integration tests)
          WHITELISTED_AUTHORS="kthoms,javahippie"
          
          # Check if author is whitelisted
          if echo "$WHITELISTED_AUTHORS" | grep -q "$PR_AUTHOR"; then
            echo "ℹ️ PR author $PR_AUTHOR is whitelisted"
            AUTHOR_WHITELISTED=true
          else
            echo "ℹ️ PR author $PR_AUTHOR is NOT whitelisted"
            AUTHOR_WHITELISTED=false
          fi
          
          # Check if PR is from Dependabot
          if [[ "$PR_AUTHOR" == "dependabot"* ]]; then
            echo "🤖 PR is from Dependabot"
            NEEDS_BUILD=true
          # Check if PR has dependency label
          elif echo "$PR_LABELS" | grep -q '"dependencies"'; then
            echo "📦 PR has dependencies label"
            NEEDS_BUILD=true
          # Check if PR has distro: labels
          elif echo "$PR_LABELS" | grep -q '"distro:'; then
            echo "🏗️ PR has distro labels"
            NEEDS_BUILD=true
          # Check if PR has database: labels
          elif echo "$PR_LABELS" | grep -q '"database:'; then
            echo "🗄️ PR has database labels"
            NEEDS_BUILD=true
          # Check if author is not whitelisted
          elif [[ "$AUTHOR_WHITELISTED" == "false" ]]; then
            echo "👤 PR author is not whitelisted, requiring integration build"
            NEEDS_BUILD=true
          else
            echo "✅ PR doesn't require integration build"
            NEEDS_BUILD=false
          fi
          
          echo "needs_build=$NEEDS_BUILD" >> $GITHUB_OUTPUT
      - name: Compute matrix values
        id: compute-matrix
        if: steps.check-pr.outputs.needs_build == 'true'
        env:
          PR_LABELS: ${{ toJson(github.event.pull_request.labels.*.name) }}
        run: |
          # Java version is always 17 for PR builds
          JAVA_VERSIONS='["17"]'
          echo "java_versions=$JAVA_VERSIONS" >> $GITHUB_OUTPUT
          
          # Determine distros based on labels
          DISTRO_LABELS=$(echo "$PR_LABELS" | jq -r '.[] | select(startswith("distro:")) | sub("distro:"; "")')
          if [[ -n "$DISTRO_LABELS" ]]; then
            # Convert to JSON array
            DISTROS=$(echo "$DISTRO_LABELS" | jq -R -s 'split("\n") | map(select(. != ""))')
            echo "🎯 Using specific distros from labels: $DISTROS"
          else
            # Default to all distros
            DISTROS='["operaton", "tomcat", "wildfly"]'
            echo "🎯 Using default distros: $DISTROS"
          fi
          echo "distros=$DISTROS" >> $GITHUB_OUTPUT
          
          # Determine databases based on labels
          DATABASE_LABELS=$(echo "$PR_LABELS" | jq -r '.[] | select(startswith("database:")) | sub("database:"; "")')
          if [[ -n "$DATABASE_LABELS" ]]; then
            # Convert to JSON array
            DATABASES=$(echo "$DATABASE_LABELS" | jq -R -s 'split("\n") | map(select(. != ""))')
            echo "🎯 Using specific databases from labels: $DATABASES"
          else
            # Default to h2 only
            DATABASES='["h2"]'
            echo "🎯 Using default database: $DATABASES"
          fi
          echo "databases=$DATABASES" >> $GITHUB_OUTPUT

  early-exit:
    name: Early Exit Check
    runs-on: ubuntu-latest
    needs: determine-pr-config
    if: github.event_name == 'pull_request' && needs.determine-pr-config.outputs.needs_integration_build == 'false'
    steps:
      - name: Cancel workflow
        run: |
          echo "🚫 Integration build not needed for this PR"
          echo "✅ PR author is whitelisted and no dependency/distro/database labels found"
          echo "Workflow will be cancelled gracefully"
          exit 0

  build:
    name: Build
    strategy:
      fail-fast: true
      matrix:
        java: ${{ github.event_name == 'pull_request' && needs.determine-pr-config.outputs.needs_integration_build == 'true' && fromJson(needs.determine-pr-config.outputs.java_versions) || fromJson(github.event.inputs.java_version || '["17", "21", "25"]') }}
    runs-on: ubuntu-latest
    needs: 
      - detect-recent-changes
      - determine-pr-config
    if: |
      always() && !cancelled() && (
        (github.event_name == 'schedule' && needs.detect-recent-changes.outputs.recent_changes == 'true') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_build == 'false') ||
        (github.event_name == 'pull_request' && needs.determine-pr-config.outputs.needs_integration_build == 'true')
      )
    outputs:
      version: ${{steps.maven-build.outputs.version}}
      project_version: ${{steps.maven-build.outputs.project_version}}
      database_version: ${{steps.maven-build.outputs.database_version}}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: "${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}"
          restore-keys: ${{ runner.os }}-m2
      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java }}
      - name: Maven Build
        id: maven-build
        shell: bash
        run: |
          .github/scripts/jacoco-create-flag-files.sh
          PROJECT_VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout | tail -n 1)
          RELEASE_VERSION=$(echo $PROJECT_VERSION | sed 's/-SNAPSHOT//')
          echo "project_version=$PROJECT_VERSION" >> $GITHUB_OUTPUT
          echo "project_version=$PROJECT_VERSION"
          echo "version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "version=$RELEASE_VERSION"
          DATABASE_VERSION=$(grep '<operaton.dbscheme.current.version>' database/pom.xml | sed -e 's/.*<operaton.dbscheme.current.version>\(.*\)<\/operaton.dbscheme.current.version>.*/\1/')
          echo "database_version=$DATABASE_VERSION" >> $GITHUB_OUTPUT
          echo "database_version=$DATABASE_VERSION"
          SKIP_TESTS=${{ github.event.inputs.skip_tests || (github.event_name == 'schedule' && false) }}
          
          CMD=".devenv/scripts/build/build.sh --profile=max --reports"
          if [ "$SKIP_TESTS" = "true" ]; then
              CMD="$CMD --skip-tests"
          fi
          $CMD

          .github/scripts/prepare-reports.sh
          ./mvnw -Psonatype-oss-release -DskipTests=true -Dskip.frontend.build=true deploy
          find target -name maven-metadata.* -delete
          ./mvnw --non-recursive org.jacoco:jacoco-maven-plugin:report-aggregate
      - name: Cache build artifacts
        uses: actions/cache/save@v4
        with:
          path: |
            distro/**/*.tar.gz
            distro/**/*.zip
            distro/webjar/target/operaton-webapp-webjar-*.jar
            ./*/staging-deploy/**
            **/target/reports/**
            **/target/surefire-reports/*.xml
            target/*.zip
          key: ${{ github.run_id }}-build-artifacts

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: 
      - detect-recent-changes
      - determine-pr-config
    if: |
      always() && !cancelled() && (
        (github.event_name == 'schedule' && needs.detect-recent-changes.outputs.recent_changes == 'true') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.integration_tests == 'true') ||
        (github.event_name == 'pull_request' && needs.determine-pr-config.outputs.needs_integration_build == 'true')
      )
    strategy:
      fail-fast: false
      matrix:
        java: ${{ github.event_name == 'pull_request' && needs.determine-pr-config.outputs.needs_integration_build == 'true' && fromJson(needs.determine-pr-config.outputs.java_versions) || fromJson(github.event.inputs.java_version || '["17", "25"]') }}
        testsuite: ${{ github.event_name == 'pull_request' && fromJson('["engine"]') || fromJson(github.event.inputs.testsuite || '["engine"]') }}
        distro: ${{ github.event_name == 'pull_request' && needs.determine-pr-config.outputs.needs_integration_build == 'true' && fromJson(needs.determine-pr-config.outputs.distros) || (github.event_name == 'schedule' && fromJson('["operaton", "tomcat", "wildfly"]') || fromJson(github.event.inputs.distro || '["operaton", "tomcat", "wildfly"]')) }}
        database: ${{ github.event_name == 'pull_request' && needs.determine-pr-config.outputs.needs_integration_build == 'true' && fromJson(needs.determine-pr-config.outputs.databases) || (github.event_name == 'schedule' && fromJson('["h2", "postgresql"]') || fromJson(github.event.inputs.database || '["h2", "postgresql", "mariadb", "mysql", "oracle", "db2"]')) }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: "${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}"
          restore-keys: ${{ runner.os }}-m2
      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java }}
      - name: Install Chromedriver
        id: install-chromedriver
        if: ${{ matrix.testsuite == 'webapps' }}
        shell: bash
        run: |
          .github/scripts/install-chrome-and-driver.sh
      - name: Maven Build
        id: maven-build
        shell: bash
        run: |
          .devenv/scripts/build/build-and-run-integration-tests.sh --testsuite=${{ matrix.testsuite }} --distro=${{ matrix.distro }} --db=${{ matrix.database }} --no-test
          .devenv/scripts/build/build-and-run-database-update-tests.sh --db=${{ matrix.database }} --no-test
      - name: Execute Integration Tests
        id: maven-integration-tests
        shell: bash
        run: |
          .devenv/scripts/build/build-and-run-integration-tests.sh --testsuite=${{ matrix.testsuite }} --distro=${{ matrix.distro }} --db=${{ matrix.database }} --no-build
      - name: Execute Database Upgrade Tests
        id: maven-db-upgrade-tests
        if: ${{ matrix.database == 'h2' }}
        shell: bash
        run: |
          .devenv/scripts/build/build-and-run-database-update-tests.sh --db=${{ matrix.database }} --no-build
      - name: Publish Test Report
        if: always()
        uses: mikepenz/action-junit-report@5b7ee5a21e8674b695313d769f3cbdfd5d4d53a4 #v6.0.0
        with:
          report_paths: ${{ github.workspace }}/**/target/*-reports/*.xml
          require_passed_tests: true
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: surefire-reports-${{ matrix.testsuite }}-${{ matrix.distro }}-${{ matrix.database }}
          path: |
            ${{ github.workspace }}/**/target/surefire-reports/**
            ${{ github.workspace }}/**/target/failsafe-reports/**
            ${{ github.workspace }}/qa/**/target/**/logs/**
            ${{ github.workspace }}/**/target/cargo.log
          retention-days: 30
          overwrite: true

  documentation:
    name: Documentation
    runs-on: ubuntu-latest
    needs:
      - detect-recent-changes
      - determine-pr-config
      - build
    if: |
      always() && !cancelled() && (
        (github.event_name == 'schedule' && needs.detect-recent-changes.outputs.recent_changes == 'true') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_build == 'false')
      )
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Documentation
        if: always()
        run: |
          .devenv/scripts/build/javadoc.sh
          .devenv/scripts/build/check-api-compatibility.sh
          .devenv/scripts/build/rest-api-doc.sh
          .devenv/scripts/build/build-sbom.sh
          pip install pystache
          distro/license-book/src/main/python/license-book-generator.py
      - name: Cache documentation artifacts
        uses: actions/cache/save@v4
        with:
          path: |
            target/*.zip
            target/sbom/**
            distro/license-book/src/main/resources/license-book.md
          key: ${{ github.run_id }}-documentation-artifacts

  release:
    name: Release
    needs:
      - detect-recent-changes
      - determine-pr-config
      - build
      - integration-tests
      - documentation
    runs-on: ubuntu-latest
    if: |
      always() && !cancelled() && (
        (github.event_name == 'schedule' && needs.detect-recent-changes.outputs.recent_changes == 'true') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_build == 'false')
      )
    steps:
      - name: Check out the code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{github.event.inputs.release_branch}}

      - name: Restore build artifacts cache
        uses: actions/cache@v4
        with:
          path: |
            distro/**/*.tar.gz
            distro/**/*.zip
            distro/webjar/target/operaton-webapp-webjar-*.jar
            ./*/staging-deploy/**
            **/target/reports/**
            **/target/surefire-reports/*.xml
            target/*.zip
          key: ${{ github.run_id }}-build-artifacts
          fail-on-cache-miss: true

      - name: Restore documentation artifacts cache
        uses: actions/cache@v4
        with:
          path: |
            target/*.zip
            target/sbom/**
            distro/license-book/src/main/resources/license-book.md
          key: ${{ github.run_id }}-documentation-artifacts
          fail-on-cache-miss: true

      - name: Release with JReleaser
        uses: jreleaser/release-action@v2
        env:
          JRELEASER_PROJECT_VERSION: ${{needs.build.outputs.project_version}}
          JRELEASER_GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
          JRELEASER_GPG_PUBLIC_KEY: ${{secrets.GPG_PUBLIC_KEY}}
          JRELEASER_GPG_SECRET_KEY: ${{secrets.GPG_PRIVATE_KEY}}
          JRELEASER_GPG_PASSPHRASE: ${{secrets.GPG_PASSPHRASE}}
          JRELEASER_MAVENCENTRAL_USERNAME: ${{secrets.OSSRH_USERNAME}}
          JRELEASER_MAVENCENTRAL_PASSWORD: ${{secrets.OSSRH_PASSWORD}}
          JRELEASER_DRY_RUN: ${{ github.event_name == 'schedule' && false || github.event.inputs.dry_run }}
          JRELEASER_PRERELEASE_ENABLED: true
        with:
          arguments: full-release -POPERATON_DATABASE_VERSION=${{needs.build.outputs.database_version}}

      - name: Publish Test Report
        if: ${{ github.event_name == 'schedule' || github.event.inputs.skip_tests == 'false'}}
        uses: mikepenz/action-junit-report@5b7ee5a21e8674b695313d769f3cbdfd5d4d53a4 #v6.0.0
        with:
          report_paths: ${{ github.workspace }}/**/target/surefire-reports/*.xml
          require_passed_tests: true

      - name: Archive Reports
        uses: actions/upload-artifact@v5
        with:
          name: reports
          path: |
            **/target/reports/**

      - name: Archive Staging Repo
        uses: actions/upload-artifact@v5
        with:
          name: staging
          path: |
            ./*/staging-deploy/**
          retention-days: 10

  post_release:
    name: Post-Release
    runs-on: ubuntu-latest
    needs:
      - detect-recent-changes
      - determine-pr-config
      - build
      - release
    if: |
      always() && !cancelled() && (
        (github.event_name == 'schedule' && needs.detect-recent-changes.outputs.recent_changes == 'true') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'false')
      )
    steps:
      - name: Notify Docker Repository
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.DOCKER_ACTION_DISPATCH_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d '{"ref":"main","inputs":{"version": "${{ needs.build.outputs.version}}","snapshot": "true"}}' \
            https://api.github.com/repos/operaton/operaton-docker/actions/workflows/build-test-and-publish.yml/dispatches)
          if [ "$response" -ne 204 ]; then
            echo "Failed to notify Docker repository. HTTP response code: $response"
            exit 1
          fi
