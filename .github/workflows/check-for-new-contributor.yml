name: First-time Contributor Check

on:
  pull_request_target:
    types: [opened]
  issues:
    types: [opened]
  issue_comment:
    types: [created]

env:
  # Whitelist of GitHub usernames who have already contributed to the repository
  # These users will not receive first-time contributor greetings
  # This list can be generated with:
  # gh pr list --repo operaton/operaton --state closed --limit 1504 --json author --jq '[.[].author.login] | unique'
  CONTRIBUTOR_WHITELIST: 'AlexanderSkrock AlexandraCiornei ArneDeutsch Brijeshthummar02 CBorowski-dev DzyhovskyiVladyslav ENate FlamieCyrex HamzaIddaoui HarshMehta112 HerrIves Jaehyeon-Han Kungi LimpBizgit MatthewIsayan Mojito060 Rapteon Satyam018 SevDan Tomnm1 Waize WoSchmo YUVI43 a-m-zill aashvgit abhayiscoding abmcmanu agoss94 ahmedfarhat alexh141048 alfh antoinecampbell aounhaider1 app/copilot-swe-agent app/dependabot app/github-actions asanderson-scottlogic ascheman atomfrede biswa1shaw cachescrubber cmoellerherm damien46061 datakurre dirk-olmes fml2 geduldia guido-marx hauptmedia herminagarg javahippie jmaster1985 joonseolee juliateles99 justfsl50 khawaja-abdullah kthoms lambdaschmied2 larsbaumeister lucabritten maxistar n1sp nevesrodrigo2 noahg9 poojary-nikesh1612 sanajitjana saumyapandey1998 sgorski00 sgort shiftyseaotter sogladev suraj9562 timtebeek tlb-lemrabott ungerts xProppi zeguilherme99'

jobs:
  greet-first-time-pr:
    name: Greet First-Time PR Contributors
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
      issues: write
    # Only run for PRs from forks (different repository) and not from operaton/operaton
    # Skip if the PR author is in the contributor whitelist
    if: |
      github.event_name == 'pull_request_target' && 
      github.event.action == 'opened' && 
      github.event.pull_request.head.repo.full_name != github.repository &&
      !contains(env.CONTRIBUTOR_WHITELIST, github.event.pull_request.user.login)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check for first-time PR contributor
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const author = context.actor;
            const { owner, repo } = context.repo;
            const prTitle = context.payload.pull_request.title;
            const prBody = context.payload.pull_request.body || "";

            console.log(`Checking for past PRs from ${author}...`);
            const allIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              creator: author,
              state: 'all'
            });

            const prs = allIssues.filter(issue => issue.pull_request);
            const prCount = prs.length;

            console.log(`Found ${prCount} PR(s) from ${author}.`);

            const alreadyConfirmed =
              /I\s+confirm/i.test(prBody) &&
              /Apache\s+License\s*2\.0/i.test(prBody) &&
              /Code\s+of\s+Conduct/i.test(prBody);

            if ((prCount === 1 || prTitle.includes('[FORCE GREETING]')) && !alreadyConfirmed) {
              let prMessage = fs.readFileSync(
                path.join(process.env.GITHUB_WORKSPACE, '.github/templates/pr_welcome.md'),
                'utf8'
              );
              prMessage = prMessage.replace(/\$\{author\}/g, author);

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.issue.number,
                body: prMessage
              });
            } else if (alreadyConfirmed) {
              console.log("Contributor already confirmed license + CoC. Skipping greeting.");
            }

  greet-first-time-issue:
    name: Greet First-Time Issue Creators
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
      issues: write
    # Skip if the issue author is in the contributor whitelist
    if: |
      github.event_name == 'issues' && 
      github.event.action == 'opened' &&
      !contains(env.CONTRIBUTOR_WHITELIST, github.event.pull_request.user.login)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check for first-time Issue creator
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const author = context.actor;
            const { owner, repo } = context.repo;
            const issueTitle = context.payload.issue.title;

            console.log(`Checking for past Issues from ${author}...`);
            const allIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              creator: author,
              state: 'all'
            });

            const issues = allIssues.filter(issue => !issue.pull_request);
            const issueCount = issues.length;

            console.log(`Found ${issueCount} Issue(s) from ${author}.`);

            if (issueCount === 1 || issueTitle.includes('[FORCE GREETING]')) {
              let issueMessage = fs.readFileSync(
                path.join(process.env.GITHUB_WORKSPACE, '.github/templates/issue_welcome.md'),
                'utf8'
              );
              issueMessage = issueMessage.replace(/\$\{author\}/g, author);

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.issue.number,
                body: issueMessage
              });
            }

  greet-first-time-comment:
    name: Greet First-Time Issue Commenters
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
      issues: write
    # Skip if the commenter is in the contributor whitelist
    if: |
      github.event_name == 'issue_comment' && 
      github.event.action == 'created' &&
      !contains(env.CONTRIBUTOR_WHITELIST, github.event.pull_request.user.login)
    steps:
      - uses: actions/checkout@v6
      - uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const author = context.actor;
            const { owner, repo } = context.repo;
            const commentBody = context.payload.comment.body;
            
            const issueAuthor = context.payload.issue.user.login;
            const isPullRequest = !!context.payload.issue.pull_request;
            
            // Skip if the author is commenting on their own issue/PR
            if (author === issueAuthor) {
              console.log(`${author} is the author of this issue/PR. Skipping greeting.`);
              return;
            }
            
            // Skip if this is a PR and the commenter has already opened a PR
            // (they would have already been greeted in their PR)
            if (isPullRequest) {
              console.log(`Checking if ${author} has opened PRs before...`);
              const allIssues = await github.paginate(github.rest.issues.listForRepo, {
                owner,
                repo,
                creator: author,
                state: 'all'
              });
              
              const prs = allIssues.filter(issue => issue.pull_request);
              if (prs.length > 0) {
                console.log(`${author} has already opened ${prs.length} PR(s). Skipping comment greeting to avoid double posting.`);
                return;
              }
            }
            
            console.log(`Checking for past comments from ${author}...`);
            const allComments = await github.paginate(github.rest.issues.listCommentsForRepo, {
              owner,
              repo
            });
            
            const userComments = allComments.filter(c => c.user.login === author);
            const commentCount = userComments.length;
            
            console.log(`Found ${commentCount} comment(s) from ${author}.`);
            
            if (commentCount === 1 || commentBody.includes('[FORCE GREETING]')) {
              let commentMessage = fs.readFileSync(
                path.join(process.env.GITHUB_WORKSPACE, '.github/templates/first_comment_on_issue.md'),
                'utf8'
              ).replace(/\$\{author\}/g, author);
            
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.issue.number,
                body: commentMessage
              });
            }