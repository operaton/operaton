name: Nightly Trigger

on:
  schedule:
    - cron: "0 3 * * *"     # Runs at 3:00 AM UTC daily
  workflow_dispatch:        # Allows manual trigger for testing

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  detect-release-branches:
    name: Detect Release Branches
    runs-on: ubuntu-slim
    permissions:
      contents: read
    outputs:
      branches: ${{ steps.list-branches.outputs.branches }}
      has_branches: ${{ steps.list-branches.outputs.has_branches }}
      all_branches: ${{ steps.list-branches.outputs.all_branches }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: List Release Branches
        id: list-branches
        run: |
          # Fetch all remote branches
          git fetch --all

          # Get all branches with release/ prefix using git for-each-ref for robustness
          BRANCHES=$(git for-each-ref --format='%(refname:short)' refs/remotes/origin/release/ | sed 's|origin/||' | sort -u)

          if [ -z "$BRANCHES" ]; then
            echo "No release branches found"
            echo "branches=[]" >> $GITHUB_OUTPUT
            echo "has_branches=false" >> $GITHUB_OUTPUT
            echo "all_branches=[\"main\"]" >> $GITHUB_OUTPUT
          else
            echo "Found release branches:"
            echo "$BRANCHES"

            # Verify jq is available
            if ! command -v jq &> /dev/null; then
              echo "Error: jq is required but not installed"
              exit 1
            fi

            # Convert to JSON array
            JSON_BRANCHES=$(echo "$BRANCHES" | jq -R -s -c 'split("\n") | map(select(. != ""))')
            echo "branches=$JSON_BRANCHES" >> $GITHUB_OUTPUT
            echo "has_branches=true" >> $GITHUB_OUTPUT

            # Combine main and release branches
            ALL_BRANCHES=$(echo "$BRANCHES" | sed '1s/^/main\n/' | jq -R -s -c 'split("\n") | map(select(. != ""))')
            echo "all_branches=$ALL_BRANCHES" >> $GITHUB_OUTPUT
          fi

  trigger-integration-builds:
    name: Trigger Integration Build for ${{ matrix.branch }}
    needs: detect-release-branches
    runs-on: ubuntu-slim
    permissions:
      actions: write
    strategy:
      fail-fast: false
      matrix:
        branch: ${{ fromJson(needs.detect-release-branches.outputs.all_branches) }}
    steps:
      - name: Trigger Integration Build Workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Triggering integration build for branch: ${{ matrix.branch }}"

          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d '{
              "ref": "${{ matrix.branch }}",
              "inputs": {
                "java_version": "[\"17\", \"21\", \"25\"]",
                "skip_build": "true",
                "skip_tests": "false",
                "integration_tests": "true",
                "testsuite": "[\"engine\", \"webapps\"]",
                "distro": "[\"operaton\", \"tomcat\", \"wildfly\"]",
                "database": "[\"h2\", \"postgresql\"]"
              }
            }' \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/integration-build.yml/dispatches)

          if [ "$response" -ne 204 ]; then
            echo "❌ Failed to trigger integration build for ${{ matrix.branch }}. HTTP response code: $response"
            exit 1
          else
            echo "✅ Successfully triggered integration build for ${{ matrix.branch }}"
          fi

  trigger-builds:
    name: Trigger Build for ${{ matrix.branch }}
    needs: detect-release-branches
    runs-on: ubuntu-slim
    permissions:
      actions: write
    strategy:
      fail-fast: false
      matrix:
        branch: ${{ fromJson(needs.detect-release-branches.outputs.all_branches) }}
    steps:
      - name: Trigger Build Workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Triggering build for branch: ${{ matrix.branch }}"

          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d '{
              "ref": "${{ matrix.branch }}",
              "inputs": {
                "profile": "max",
                "reports": "true",
                "skip_tests": "false"
              }
            }' \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/build.yml/dispatches)

          if [ "$response" -ne 204 ]; then
            echo "❌ Failed to trigger build for ${{ matrix.branch }}. HTTP response code: $response"
            exit 1
          else
            echo "✅ Successfully triggered build for ${{ matrix.branch }}"
          fi
