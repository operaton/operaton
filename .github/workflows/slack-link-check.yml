name: Check Slack Invite Link

on:
  schedule:
    - cron: "36 16 * * *"   # run daily at 16:36 UTC
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install system Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser || sudo apt-get install -y chromium

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Playwright core (no browser download)
        run: npm install playwright

      - name: Extract Slack link from README
        id: extract
        run: |
          url=$(grep -oP '(?<=\().*join\.slack\.com[^)]*' README.md | head -1)
          echo "url=$url" >> $GITHUB_OUTPUT

      - name: Check Slack invite status
        id: check
        run: |
          node - << 'EOF'
          const { chromium } = require("playwright");
          const url = "${{ steps.extract.outputs.url }}";

          async function run() {
            const paths = [
              "/usr/bin/chromium-browser",
              "/usr/bin/chromium",
              "/snap/bin/chromium"
            ];

            let browser;
            for (const p of paths) {
              try {
                browser = await chromium.launch({ executablePath: p, headless: true });
                break;
              } catch (e) {}
            }
            if (!browser) {
              console.error("No system chromium found.");
              process.exit(1);
            }

            const page = await browser.newPage();
            await page.goto(url, { waitUntil: "networkidle" });
            const finalUrl = page.url();

            console.log("Final URL:", finalUrl);

            if (finalUrl.includes("signup")) {
              console.log("EXPIRED");
              await browser.close();
              process.exit(10);
            }

            if (finalUrl.includes("join")) {
              console.log("ACTIVE");
              await browser.close();
              process.exit(0);
            }

            console.log("UNKNOWN");
            await browser.close();
            process.exit(0);
          }

          run();
          EOF
        continue-on-error: true

      - name: Determine if expired
        id: expired
        run: |
          if [ "${{ steps.check.outcome }}" = "failure" ]; then
            echo "expired=true" >> $GITHUB_OUTPUT
          else
            echo "expired=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue if expired
        if: ${{ steps.expired.outputs.expired == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "Slack invite link expired",
              body: `The Slack invite link in README is expired.\n\nURL: ${{ steps.extract.outputs.url }}`
            });
