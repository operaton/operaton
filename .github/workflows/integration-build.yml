name: Integration Build

on:
  schedule:
    - cron: "0 2 * * *"     # Runs at 2:00 AM UTC daily
  pull_request:
    branches:
      - main
      - release/*
  push:
    branches:
      - release/*
      # when developing the workflow itself, create this branch and push to it
      - ci-dev/integration-build
  workflow_dispatch:        # Allows manual trigger
    inputs:
      java_version:
        description: 'Java version to use'
        type: choice
        required: true
        default: '["17"]'
        options:
          - '["17"]'
          - '["21"]'
          - '["25"]'
          - '["17", "21"]'
          - '["17", "25"]'
          - '["21", "25"]'
          - '["17", "21", "25"]'
      skip_build:
        description: 'Build: By default skipped. Deactivate to perform the regular project build'
        type: boolean
        default: true
      skip_tests:
        description: 'Build: Skip test execution for faster build'
        type: boolean
        default: true
      integration_tests:
        description: 'Integration Tests: Enable/Disable'
        type: boolean
        default: true
      testsuite:
        description: 'Integration Tests: Test suite to run'
        type: choice
        required: true
        default: '["engine", "webapps"]'
        options:
          - '["engine"]'
          - '["webapps"]'
          - '["engine", "webapps"]'
      distro:
        description: 'Integration Tests: Distribution to use'
        type: choice
        required: true
        default: '["operaton", "tomcat", "wildfly"]'
        options:
          - '["operaton"]'
          - '["tomcat"]'
          - '["wildfly"]'
          - '["operaton", "tomcat", "wildfly"]'
      database:
        description: 'Integration Tests: Database to use'
        type: choice
        required: true
        default: '["h2"]'
        options:
          - '["h2"]'
          - '["postgresql"]'
          - '["postgresql-xa"]'
          - '["mariadb"]'
          - '["sqlserver"]'
          - '["mysql"]'
          - '["oracle"]'
          - '["db2"]'
          - '["h2", "postgresql"]'
          - '["h2", "postgresql", "mariadb", "mysql", "oracle", "db2"]'
      perform_documentation:
        description: 'Enable to build documentation (javadoc, rest-api, clirr, sbom)'
        type: boolean
        required: true
        default: false
      perform_release:
        description: 'Enable to perform release actions (simulate scheduled release builds)'
        type: boolean
        required: true
        default: false
      dry_run:
        description: 'Dry run: Skips remote operations (e.g. Maven Central, Docker) when true'
        type: boolean
        required: true
        default: false

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  determine-build-config:
    name: Determine PR Configuration
    runs-on: ubuntu-latest
    needs:
      - detect-recent-changes
    outputs:
      needs_build:              ${{ steps.check-pr.outputs.needs_build }}
      needs_integration_build:  ${{ steps.check-pr.outputs.needs_integration_build }}
      needs_documentation:      ${{ steps.check-pr.outputs.needs_documentation }}
      needs_release:            ${{ steps.check-pr.outputs.needs_release }}
      recent_changes:           ${{ steps.check-pr.outputs.recent_changes }}
      skip_tests:               ${{ steps.check-pr.outputs.recent_changes }}
      dry_run:                  ${{ steps.check-pr.outputs.dry_run }}
      java_versions:            ${{ steps.compute-matrix.outputs.java_versions }}
      distros:                  ${{ steps.compute-matrix.outputs.distros }}
      databases:                ${{ steps.compute-matrix.outputs.databases }}
      test_suites:              ${{ steps.compute-matrix.outputs.test_suites }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Check PR conditions
        id: check-pr
        env:
          PR_LABELS:                    ${{ toJson(github.event.pull_request.labels.*.name) }}
          PR_AUTHOR:                    ${{ github.event.pull_request.user.login }}
          EVENT_NAME:                   ${{ github.event_name }}
          INPUT_INTEGRATION_TESTS:      ${{ github.event.inputs.integration_tests }}
          INPUT_SKIP_BUILD:             ${{ github.event.inputs.skip_build }}
          INPUT_SKIP_TESTS:             ${{ github.event.inputs.skip_tests }}
          INPUT_PERFORM_DOCUMENTATION:  ${{ github.event.inputs.perform_documentation }}
          INPUT_PERFORM_RELEASE:        ${{ github.event.inputs.perform_release }}
          INPUT_DRY_RUN:                ${{ github.event.inputs.dry_run || 'true' }}
        run: |
          echo "PR Labels: $PR_LABELS"
          echo "PR Author: $PR_AUTHOR"
          NEED_BUILS=true
          NEEDS_INTEGRATION_BUILD=true
          NEEDS_DOCUMENTATION=$INPUT_PERFORM_DOCUMENTATION
          NEEDS_RELEASE=$INPUT_PERFORM_RELEASE
          DRY_RUN=$INPUT_DRY_RUN
          HAS_RECENT_CHANGES=false
          SKIP_TESTS=$INPUT_SKIP_TESTS
          
          COMMITS=$(git rev-list --since="24 hours ago" HEAD)
          if [ -z "$COMMITS" ]; then
            echo "ðŸ”ŽâŒ No commits in the last 24 hours detected."
          else
            echo "ðŸ”Žâœ”ï¸ Commits within the last 24 hours detected."
            HAS_RECENT_CHANGES=true
          fi

          # Define whitelisted authors (core team members who don't need full integration tests)
          WHITELISTED_AUTHORS="kthoms,javahippie"
          
          # Check if author is whitelisted
          if echo "$WHITELISTED_AUTHORS" | grep -q "$PR_AUTHOR"; then
            echo "â„¹ï¸ PR author $PR_AUTHOR is whitelisted"
            AUTHOR_WHITELISTED=true
          else
            echo "â„¹ï¸ PR author $PR_AUTHOR is NOT whitelisted"
            AUTHOR_WHITELISTED=false
          fi
          
          # Check if PR is from Dependabot
          if [[ "$EVENT_NAME" == "schedule" && -z "$COMMITS" ]]; then
            echo "â° Scheduled run, requiring integration build"
            NEEDS_DOCUMENTATION=true
            NEEDS_RELEASE=true
            DRY_RUN=false
            SKIP_TESTS=false
          elif [[ "$EVENT_NAME" == "pull_request" || "$EVENT_NAME" == "push" ]]; then
            echo "ðŸ”€ Pull request event, evaluating conditions"            
            # Check if PR has dependency label
            if echo "$PR_LABELS" | grep -q '"dependencies"'; then
              echo "ðŸ“¦ PR has dependencies label"
            # Check if PR has distro: labels
            elif echo "$PR_LABELS" | grep -q '"distro:'; then
              echo "ðŸ—ï¸ PR has distro labels"
            # Check if PR has database: labels
            elif echo "$PR_LABELS" | grep -q '"database:'; then
              echo "ðŸ—„ï¸ PR has database labels"
            elif [[ "$PR_AUTHOR" == "dependabot"* ]]; then
              echo "ðŸ¤– PR is from Dependabot"
            # Check if author is not whitelisted
            elif [[ "$AUTHOR_WHITELISTED" == "false" ]]; then
              echo "ðŸ‘¤ PR author is not whitelisted, requiring integration build"
            else
              NEEDS_INTEGRATION_BUILD=false
            fi
          elif [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
              echo "ðŸš€ Manual workflow dispatch"
              if [[ "$INPUT_SKIP_BUILD" == "true" ]]; then
                  echo "â„¹ï¸ Build skipped as per input"
                  NEEDS_BUILD=false
              fi  
              if [[ "$INPUT_INTEGRATION_TESTS" == "false" ]]; then
                echo "â„¹ï¸ Integration tests not requested"
                NEEDS_INTEGRATION_BUILD=false
              fi
          else
            echo "â„¹ï¸ Event type $EVENT_NAME does not require integration build by default"
            NEEDS_INTEGRATION_BUILD=false
          fi
          
          if [[ "$INPUT_SKIP_BUILD" == "false" ]]; then
              echo "âš ï¸ Build skipped"
          fi  
          if [[ "$NEEDS_INTEGRATION_BUILD" == "false" ]]; then
            echo "âš ï¸ Integration build not required"
          fi
          
          echo "needs_integration_build=$NEEDS_INTEGRATION_BUILD" >> $GITHUB_OUTPUT
          echo "needs_build=$NEEDS_BUILD" >> $GITHUB_OUTPUT
          echo "needs_documentation=$NEEDS_DOCUMENTATION" >> $GITHUB_OUTPUT
          echo "needs_release=$NEEDS_RELEASE" >> $GITHUB_OUTPUT
          echo "recent_changes=$HAS_RECENT_CHANGES" >> $GITHUB_OUTPUT
          echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT
          echo "skip_tests=$SKIP_TESTS" >> $GITHUB_OUTPUT
      - name: Compute matrix values
        id: compute-matrix
        if: steps.check-pr.outputs.needs_integration_build == 'true'
        env:
          PR_LABELS:          ${{ toJson(github.event.pull_request.labels.*.name) }}
          EVENT_NAME:         ${{ github.event_name }}
          INPUT_JAVA_VERSION: ${{ fromJson(github.event.inputs.java_version || '["17", "21", "25"]') }}
          INPUT_DISTROS:      ${{ fromJson(github.event.inputs.distro || '["operaton", "tomcat", "wildfly"]') }}
          INPUT_DATABASES:    ${{ fromJson(github.event.inputs.database || '["h2", "postgresql", "mariadb", "mysql", "oracle", "db2"]') }}
          INPUT_TESTSUITES:   ${{ fromJson(github.event.inputs.testsuite || '["engine", "webapps" ]') }}
        run: |
          # Java version is always 17 for PR builds
          JAVA_VERSIONS=$INPUT_JAVA_VERSION
          DISTROS=$INPUT_DISTROS
          DATABASES=$INPUT_DATABASES
          TEST_SUITES=$INPUT_TESTSUITES
          
          if [[ "$EVENT_NAME" == "pull_request" || "$EVENT_NAME" == "push" ]]; then
            JAVA_VERSIONS='["17"]'
            echo "ðŸŽ¯ Using Java version 17 for PR/Push builds"
          else
            echo "ðŸŽ¯ Using Java versions from input: $JAVA_VERSIONS"
          fi
          echo "java_versions=$JAVA_VERSIONS" >> $GITHUB_OUTPUT
          
          # Determine distros based on labels
          DISTRO_LABELS=$(echo "$PR_LABELS" | jq -r '.[] | select(startswith("distro:")) | sub("distro:"; "")')
          if [[ -n "$DISTRO_LABELS" ]]; then
            # Convert to JSON array
            DISTROS=$(echo "$DISTRO_LABELS" | jq -R -s 'split("\n") | map(select(. != ""))')
            echo "ðŸŽ¯ Using specific distros from labels: $DISTROS"
          else
            # Default to all distros
            DISTROS='["operaton", "tomcat", "wildfly"]'
            echo "ðŸŽ¯ Using default distros: $DISTROS"
          fi
          echo "distros=$DISTROS" >> $GITHUB_OUTPUT
          
          # Determine databases based on labels
          DATABASE_LABELS=$(echo "$PR_LABELS" | jq -r '.[] | select(startswith("database:")) | sub("database:"; "")')
          if [[ -n "$DATABASE_LABELS" ]]; then
            # Convert to JSON array
            DATABASES=$(echo "$DATABASE_LABELS" | jq -R -s 'split("\n") | map(select(. != ""))')
            echo "ðŸŽ¯ Using specific databases from labels: $DATABASES"
          elif [[ "$EVENT_NAME" == "pull_request" || "$EVENT_NAME" == "push" ]]; then
            DATABASES='["h2"]'
            echo "ðŸŽ¯ Using H2 database for PR/Push builds"
          fi
          echo "databases=$DATABASES" >> $GITHUB_OUTPUT
          
          echo "test_suites=$TEST_SUITES" >> $GITHUB_OUTPUT

  early-exit:
    name: Early Exit Check
    runs-on: ubuntu-latest
    needs: determine-build-config
    if: needs.determine-build-config.outputs.needs_integration_build == 'false'
    steps:
      - name: Cancel workflow
        run: |
          echo "ðŸš« Integration build not needed for this PR"
          echo "âœ… PR author is whitelisted and no dependency/distro/database labels found"
          echo "Workflow will be cancelled gracefully"
          exit 0

  build:
    name: Build
    strategy:
      fail-fast: true
      matrix:
        java: ${{ fromJson(needs.determine-build-config.outputs.java_versions) }}
    runs-on: ubuntu-latest
    needs: 
      - determine-build-config
    if: |
      always() && !cancelled() && (needs.determine-build-config.outputs.needs_build == 'true')
    outputs:
      version:          ${{steps.maven-build.outputs.version}}
      project_version:  ${{steps.maven-build.outputs.project_version}}
      database_version: ${{steps.maven-build.outputs.database_version}}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: "${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}"
          restore-keys: ${{ runner.os }}-m2
      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java }}
      - name: Maven Build
        id: maven-build
        shell: bash
        run: |
          .github/scripts/jacoco-create-flag-files.sh
          PROJECT_VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout | tail -n 1)
          RELEASE_VERSION=$(echo $PROJECT_VERSION | sed 's/-SNAPSHOT//')
          echo "project_version=$PROJECT_VERSION" >> $GITHUB_OUTPUT
          echo "project_version=$PROJECT_VERSION"
          echo "version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "version=$RELEASE_VERSION"
          DATABASE_VERSION=$(grep '<operaton.dbscheme.current.version>' database/pom.xml | sed -e 's/.*<operaton.dbscheme.current.version>\(.*\)<\/operaton.dbscheme.current.version>.*/\1/')
          echo "database_version=$DATABASE_VERSION" >> $GITHUB_OUTPUT
          echo "database_version=$DATABASE_VERSION"
          SKIP_TESTS=${{ github.event.inputs.skip_tests || (github.event_name == 'schedule' && false) }}
          
          CMD=".devenv/scripts/build/build.sh --profile=max --reports"
          if [ "$SKIP_TESTS" = "true" ]; then
              CMD="$CMD --skip-tests"
          fi
          $CMD

          .github/scripts/prepare-reports.sh
          ./mvnw -Psonatype-oss-release -DskipTests=true -Dskip.frontend.build=true deploy
          find target -name maven-metadata.* -delete
          ./mvnw --non-recursive org.jacoco:jacoco-maven-plugin:report-aggregate
      - name: Cache build artifacts
        uses: actions/cache/save@v4
        with:
          path: |
            distro/**/*.tar.gz
            distro/**/*.zip
            distro/webjar/target/operaton-webapp-webjar-*.jar
            ./*/staging-deploy/**
            **/target/reports/**
            **/target/surefire-reports/*.xml
            target/*.zip
          key: ${{ github.run_id }}-build-artifacts

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: 
      - determine-build-config
    if: |
      always() && !cancelled() && (needs.determine-build-config.outputs.needs_integration_build == 'true')
    strategy:
      fail-fast: false
      matrix:
        java:      ${{ fromJson(needs.determine-build-config.outputs.java_versions)  }}
        testsuite: ${{ fromJson(needs.determine-build-config.outputs.test_suites) }}
        distro:    ${{ fromJson(needs.determine-build-config.outputs.distros) }}
        database:  ${{ fromJson(needs.determine-build-config.outputs.databases) }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: "${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}"
          restore-keys: ${{ runner.os }}-m2
      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java }}
      - name: Install Chromedriver
        id: install-chromedriver
        if: ${{ matrix.testsuite == 'webapps' }}
        shell: bash
        run: |
          .github/scripts/install-chrome-and-driver.sh
      - name: Maven Build
        id: maven-build
        shell: bash
        run: |
          .devenv/scripts/build/build-and-run-integration-tests.sh --testsuite=${{ matrix.testsuite }} --distro=${{ matrix.distro }} --db=${{ matrix.database }} --no-test
          .devenv/scripts/build/build-and-run-database-update-tests.sh --db=${{ matrix.database }} --no-test
      - name: Execute Integration Tests
        id: maven-integration-tests
        shell: bash
        run: |
          .devenv/scripts/build/build-and-run-integration-tests.sh --testsuite=${{ matrix.testsuite }} --distro=${{ matrix.distro }} --db=${{ matrix.database }} --no-build
      - name: Execute Database Upgrade Tests
        id: maven-db-upgrade-tests
        if: ${{ matrix.database == 'h2' }}
        shell: bash
        run: |
          .devenv/scripts/build/build-and-run-database-update-tests.sh --db=${{ matrix.database }} --no-build
      - name: Publish Test Report
        if: always()
        uses: mikepenz/action-junit-report@e08919a3b1fb83a78393dfb775a9c37f17d8eea6 #v6.0.1
        with:
          report_paths: ${{ github.workspace }}/**/target/*-reports/*.xml
          require_passed_tests: true
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: surefire-reports-${{ matrix.testsuite }}-${{ matrix.distro }}-${{ matrix.database }}
          path: |
            ${{ github.workspace }}/**/target/surefire-reports/**
            ${{ github.workspace }}/**/target/failsafe-reports/**
            ${{ github.workspace }}/qa/**/target/**/logs/**
            ${{ github.workspace }}/**/target/cargo.log
          retention-days: 30
          overwrite: true

  documentation:
    name: Documentation
    runs-on: ubuntu-latest
    needs:
      - determine-build-config
    if: |
      always() && !cancelled() && (needs.detect-recent-changes.outputs.needs_documentation == 'true')
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Documentation
        run: |
          .devenv/scripts/build/javadoc.sh
          .devenv/scripts/build/check-api-compatibility.sh
          .devenv/scripts/build/rest-api-doc.sh
          .devenv/scripts/build/build-sbom.sh
          pip install pystache
      - name: Cache documentation artifacts
        uses: actions/cache/save@v4
        with:
          path: |
            target/*.zip
            target/sbom/**
          key: ${{ github.run_id }}-documentation-artifacts

  release:
    name: Release
    needs:
      - determine-build-config
      - build
      - integration-tests
      - documentation
    runs-on: ubuntu-latest
    if: |
      always() && !cancelled() && (needs.detect-recent-changes.outputs.needs_release == 'true')
    steps:
      - name: Check out the code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{github.event.inputs.release_branch}}

      - name: Restore build artifacts cache
        uses: actions/cache@v4
        with:
          path: |
            distro/**/*.tar.gz
            distro/**/*.zip
            distro/webjar/target/operaton-webapp-webjar-*.jar
            ./*/staging-deploy/**
            **/target/reports/**
            **/target/surefire-reports/*.xml
            target/*.zip
          key: ${{ github.run_id }}-build-artifacts
          fail-on-cache-miss: true

      - name: Restore documentation artifacts cache
        uses: actions/cache@v4
        with:
          path: |
            target/*.zip
            target/sbom/**
          key: ${{ github.run_id }}-documentation-artifacts
          fail-on-cache-miss: true

      - name: Release with JReleaser
        uses: jreleaser/release-action@v2
        env:
          JRELEASER_PROJECT_VERSION: ${{needs.build.outputs.project_version}}
          JRELEASER_GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
          JRELEASER_GPG_PUBLIC_KEY: ${{secrets.GPG_PUBLIC_KEY}}
          JRELEASER_GPG_SECRET_KEY: ${{secrets.GPG_PRIVATE_KEY}}
          JRELEASER_GPG_PASSPHRASE: ${{secrets.GPG_PASSPHRASE}}
          JRELEASER_MAVENCENTRAL_USERNAME: ${{secrets.OSSRH_USERNAME}}
          JRELEASER_MAVENCENTRAL_PASSWORD: ${{secrets.OSSRH_PASSWORD}}
          JRELEASER_DRY_RUN: ${{ github.event_name == 'schedule' && false || github.event.inputs.dry_run }}
        with:
          arguments: full-release -POPERATON_DATABASE_VERSION=${{needs.build.outputs.database_version}}

      - name: Publish Test Report
        if: ${{ needs.determine-build-config.outputs.needs_integration_build == 'true' || needs.determine-build-config.outputs.skip_tests == 'true' == 'false'}}
        uses: mikepenz/action-junit-report@e08919a3b1fb83a78393dfb775a9c37f17d8eea6 #v6.0.1
        with:
          report_paths: ${{ github.workspace }}/**/target/surefire-reports/*.xml
          require_passed_tests: true

      - name: Archive Reports
        uses: actions/upload-artifact@v5
        with:
          name: reports
          path: |
            **/target/reports/**

      - name: Archive Staging Repo
        uses: actions/upload-artifact@v5
        with:
          name: staging
          path: |
            ./*/staging-deploy/**
          retention-days: 10

  post_release:
    name: Post-Release
    runs-on: ubuntu-latest
    needs:
      - determine-build-config
      - release
    if: |
      always() && !cancelled() && (needs.detect-recent-changes.outputs.needs_release == 'true') && (needs.detect-recent-changes.outputs.dry_run == 'false')
    steps:
      - name: Notify Docker Repository
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.DOCKER_ACTION_DISPATCH_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d '{"ref":"main","inputs":{"version": "${{ needs.build.outputs.version}}","snapshot": "true"}}' \
            https://api.github.com/repos/operaton/operaton-docker/actions/workflows/build-test-and-publish.yml/dispatches)
          if [ "$response" -ne 204 ]; then
            echo "Failed to notify Docker repository. HTTP response code: $response"
            exit 1
          fi
