# This workflow builds Operaton, and cache/restore any dependencies to improve the workflow execution time
name: build

on:
  push:
    branches:
      - main
      - release/**
    paths-ignore:
      - '.github/workflows/**'
      - '!.github/workflows/build.yml'
      - '.github/jreleaser/changelog.tpl'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
      - '.github/dependabot.yml'
      - '.github/workflows/auto-merge.yml'
      - '**/*.md'
      - 'distro/**'
      - 'settings/**'
      - '.gitingore'
      - 'LICENSE'
      - 'NOTICE'
      - 'jreleaser.yml'
  pull_request:
    branches:
      - main
      - release/**
    paths-ignore:
      - '.github/workflows/**'
      - '!.github/workflows/build.yml'
      - '.github/jreleaser/changelog.tpl'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
      - '.github/dependabot.yml'
      - '**/*.md'
      - 'distro/**'
      - 'settings/**'
      - '.gitingore'
      - 'LICENSE'
      - 'NOTICE'
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile to use'
        type: choice
        required: true
        default: 'normal'
        options:
          - 'fast'
          - 'normal'
          - 'max'
      reports:
        description: 'Enable build reports'
        type: boolean
        required: true
        default: false
      runner:
        description: 'Maven runner to use'
        type: choice
        required: true
        default: 'mvnd'
        options:
          - 'mvnw'
          - 'mvnd'
      skip_tests:
        description: 'Skip test execution'
        type: boolean
        required: true
        default: false

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  lint-adr:
    name: Lint ADRs
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            docs/decisions
      - name: Lint ADR files
        # version: v20.0.0 - pinned to specific commit for security
        uses: DavidAnson/markdownlint-cli2-action@07035fd053f7be764496c0f8d8f9f41f98305101
        with:
          globs: |
            docs/decisions/*.md

  build:
    name: Build
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      checks: write
      actions: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Cache Maven packages
        uses: actions/cache@v5
        with:
          path: ~/.m2
          key: "${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}"
          restore-keys: ${{ runner.os }}-m2
      - name: Cache SonarCloud packages
        uses: actions/cache@v5
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'npm'
          # Use a glob pattern to include all package-lock.json files
          # This ensures the cache is unique based on ANY lock file change
          cache-dependency-path: '**/package-lock.json'
      - name: Setup mvnd
        uses: ./.github/actions/mvnd-setup
      - name: Maven Build
        id: maven-build
        shell: bash
        run: |
          .github/scripts/jacoco-create-flag-files.sh

          # Build command construction
          BUILD_CMD=".devenv/scripts/build/build.sh"

          # Add profile parameter
          PROFILE="${{ github.event.inputs.profile || 'normal' }}"
          BUILD_CMD="$BUILD_CMD --profile=$PROFILE"

          # Add runner parameter
          RUNNER="${{ github.event.inputs.runner || 'mvnd' }}"
          BUILD_CMD="$BUILD_CMD --runner=$RUNNER"

          # Add reports flag if enabled
          REPORTS="${{ github.event.inputs.reports || 'false' }}"
          if [ "$REPORTS" = "true" ]; then
            BUILD_CMD="$BUILD_CMD --reports"
          fi

          # Add skip-tests flag if enabled
          SKIP_TESTS="${{ github.event.inputs.skip_tests || 'false' }}"
          if [ "$SKIP_TESTS" = "true" ]; then
            BUILD_CMD="$BUILD_CMD --skip-tests"
          fi

          echo "ℹ️ Executing: $BUILD_CMD"
          $BUILD_CMD

          ./mvnw --non-recursive org.jacoco:jacoco-maven-plugin:report-aggregate
      - name: Publish Test Report
        if: always()
        uses: mikepenz/action-junit-report@a294a61c909bd8a4b563024a2faa28897fd53ebc #v6.1.0
        continue-on-error: true
        with:
          report_paths: ${{ github.workspace }}/**/target/surefire-reports/*.xml
          require_passed_tests: true
      - name: Upload Surefire Reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: surefire-reports
          path: ${{ github.workspace }}/**/target/surefire-reports/**
          retention-days: 30
      - name: Sonarqube Analysis
        if: env.SONAR_TOKEN && (github.ref == 'refs/heads/main' || github.event_name == 'pull_request')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        shell: bash
        run: |
          ./mvnw org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
          -Dsonar.projectKey=operaton_operaton \
          -Dsonar.exclusions=webapps/assembly/**,\
              qa/performance-tests-engine/**,\
              qa/integration-tests-webapps/**,\
              qa/integration-tests-engine/** \
          -Dsonar.coverage.exclusions=qa/performance-tests-engine/**,\
              qa/integration-tests-webapps/**,\
              qa/integration-tests-engine/**,\
              webapps/**
        continue-on-error: true
      - name: Cache build artifacts
        uses: actions/cache/save@v5
        with:
          path: |
            distro/**/target/operaton-*.gz
            distro/webjar/target/operaton-webapp-webjar-*.jar
          key: ${{ github.run_id }}-build-artifacts

  publish:
    name: Publish
    needs: build
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      actions: write
    env:
      GH_TOKEN: ${{ github.token }}
    continue-on-error: true
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Restore build artifacts cache
        id: restore-build-artifacts
        uses: actions/cache/restore@v5
        with:
          path: |
            distro/**/target/operaton-*.gz
            distro/webjar/target/operaton-webapp-webjar-*.jar
          key: ${{ github.run_id }}-build-artifacts
      - id: set-versions
        if: steps.restore-build-artifacts.outputs.cache-hit == 'true'
        run: |
          sudo apt-get update > /dev/null
          sudo apt-get install -y xq > /dev/null
          PROJECT_VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout | tail -n 1)
          TOMCAT_VERSION=$(xq --xpath project/properties/version.tomcat parent/pom.xml)
          echo "PROJECT_VERSION=$PROJECT_VERSION" >> $GITHUB_ENV
          echo "TOMCAT_VERSION=$TOMCAT_VERSION" >> $GITHUB_ENV
      - name: Delete build cache
        if: steps.restore-build-artifacts.outputs.cache-hit == 'true'
        continue-on-error: true
        run: gh cache delete ${{ github.run_id }}-build-artifacts
      - name: Upload distro Tomcat
        id: upload-distro-tomcat
        if: steps.restore-build-artifacts.outputs.cache-hit == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: Operaton (Tomcat ${{ env.TOMCAT_VERSION }} Bundle)
          path: distro/tomcat/distro/target/operaton-bpm-tomcat-${{ env.PROJECT_VERSION }}.tar.gz
          if-no-files-found: error
          retention-days: 10
      - name: Upload distro sql-scripts
        id: upload-distro-sql-scripts
        if: steps.restore-build-artifacts.outputs.cache-hit == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: Operaton SQL Scripts
          path: distro/sql-script/target/operaton-sql-scripts-*.tar.gz
          if-no-files-found: error
          retention-days: 10
